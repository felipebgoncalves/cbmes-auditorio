<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>CBMES – Agenda do Auditório</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <style>
    :root {
      --cbmes-red: #c71c22;
      --bg: #f4f5f7;
      --surface: #ffffff;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 16px;
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, sans-serif;
      background: var(--bg);
      color: #222;
    }

    /* Cabeçalho da página (Acesso interno no canto direito) */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 22px;
      background: #1f2430;
      color: #fff;
    }
    .page-header-title {
      font-size: .9rem;
      font-weight: 600;
    }
    .page-header-sub {
      font-size: .72rem;
      opacity: .8;
    }

    .btn-secundario {
      border-radius: 999px;
      border: 1px solid #fff;
      background: transparent;
      color: #fff;
      font-weight: 600;
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .btn-secundario:hover {
      background: rgba(255,255,255,.12);
    }

    main {
      padding: 20px;
      max-width: 1150px;
      margin: 0 auto;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 18px 18px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .top-bar h2 {
      margin: 0;
      font-size: 1rem;
    }

    .legenda {
      font-size: .75rem;
      color: #555;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }
    .badge {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
      margin-right: 4px;
      vertical-align: middle;
    }
    .badge-pendente { background: #f6c344; }
    .badge-aprovada { background: #c71c22; }
    .badge-livre    { background: #2da34f; }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primario {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: .8rem;
      font-weight: 600;
      background: var(--cbmes-red);
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-primario:hover {
      background: #a8151c;
    }

    #calendar {
      margin-top: 12px;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 18px 45px rgba(0,0,0,.25);
      max-width: 780px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
      padding: 20px 22px 18px;
    }
    .modal-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:8px;
    }
    .modal-title {
      margin:0;
      font-size:1.05rem;
    }
    .modal-close {
      border:none;
      background:none;
      font-size:1.2rem;
      cursor:pointer;
    }

    .modal-sub {
      font-size:.78rem;
      color:#555;
      margin:0 0 10px;
    }

    .form-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap:10px 14px;
      font-size:.8rem;
    }
    .form-group {
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .form-group label {
      font-size:.75rem;
      font-weight:600;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      border-radius: 8px;
      border:1px solid #ccd1db;
      padding:7px 9px;
      font-size:.8rem;
      font-family:inherit;
    }
    .form-group textarea {
      min-height:70px;
      resize:vertical;
    }
    .form-footer {
      margin-top:12px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .btn-outline {
      border-radius:999px;
      border:1px solid #b0b5c3;
      background:#fff;
      font-size:.8rem;
      padding:7px 14px;
      cursor:pointer;
    }

    @media (max-width: 600px) {
      .page-header { padding: 8px 12px; }
      main { padding: 12px; }
      .card { padding: 12px 12px 14px; }
      .top-bar { align-items:flex-start; }
    }
  </style>
</head>
<body>
<header class="page-header">
  <div>
    <div class="page-header-title">Sistema de Agendamento do Auditório – CBMES</div>
    <div class="page-header-sub">Uso compartilhado do auditório do QCG – Corpo de Bombeiros Militar do ES</div>
  </div>
  <button id="btnAcessoInterno" class="btn-secundario">Acesso interno</button>
</header>

<main>
  <div class="card">
    <div class="top-bar">
      <div>
        <h2>Agenda do Auditório</h2>
        <div class="legenda">
          <span><span class="badge badge-pendente"></span> Solicitação em análise</span>
          <span><span class="badge badge-aprovada"></span> Reserva confirmada</span>
          <span><span class="badge badge-livre"></span> Ausência de marcação = disponível</span>
        </div>
      </div>
      <div class="top-actions">
        <button id="btnAbrirModal" class="btn-primario">+ Nova solicitação</button>
      </div>
    </div>

    <div id="calendar"></div>
  </div>
</main>

<!-- Modal de nova solicitação -->
<div id="modalReserva" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Nova solicitação de uso do auditório</h3>
      <button id="btnFecharModal" class="modal-close">&times;</button>
    </div>
    <p class="modal-sub">
      Escolha uma data e veremos os períodos livres. Preencha os dados abaixo e envie sua solicitação.
    </p>

    <form id="formReserva" class="form-grid">
      <div class="form-group">
        <label>Tipo de solicitação *</label>
        <select name="tipo_solicitacao" required>
          <option value="">Selecione</option>
          <option value="INTERNA">Interna (CBMES)</option>
          <option value="EXTERNA">Externa (demais órgãos)</option>
        </select>
      </div>

      <div class="form-group">
        <label>Órgão / Instituição solicitante *</label>
        <input required name="instituicao" />
      </div>

      <div class="form-group">
        <label>Responsável *</label>
        <input required name="responsavel" />
      </div>

      <div class="form-group">
        <label>E-mail de contato *</label>
        <input required type="email" name="email" />
      </div>

      <div class="form-group">
        <label>Telefone / WhatsApp *</label>
        <input required name="telefone" placeholder="(27) 99999-0000" />
      </div>

      <div class="form-group">
        <label>Data inicial *</label>
        <input type="date" name="data_evento" id="inputDataInicio" required />
      </div>

      <div class="form-group">
        <label>Data final *</label>
        <input type="date" name="data_fim" id="inputDataFim" required />
      </div>

      <div class="form-group">
        <label>Período *</label>
        <select name="periodo" id="selectPeriodo" required></select>
      </div>

      <div class="form-group">
        <label>Finalidade do evento *</label>
        <select name="finalidade" required>
          <option value="">Selecione</option>
          <option value="Reunião interna CBMES">Reunião interna CBMES</option>
          <option value="Reunião entre órgãos">Reunião entre órgãos</option>
          <option value="Treinamento / Curso">Treinamento / Curso</option>
          <option value="Palestra / Seminário">Palestra / Seminário</option>
          <option value="Cerimônia / Solenidade">Cerimônia / Solenidade</option>
          <option value="Outro">Outro</option>
        </select>
      </div>


      <div class="form-group">
        <label>Anexo (ofício / e-Docs) – opcional</label>
        <input type="file" name="anexo" />
      </div>

      <div class="form-group" style="grid-column:1 / -1;">
        <label>Observações adicionais</label>
        <textarea name="observacoes" placeholder="Informações complementares, necessidades especiais etc."></textarea>
      </div>
    </form>

    <div class="form-footer">
      <button class="btn-outline" id="btnCancelarModal" type="button">Cancelar</button>
      <button class="btn-primario" id="btnEnviarReserva" type="button">Enviar solicitação</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const API_BASE = '/api';

    const modalBackdrop = document.getElementById('modalReserva');
    const btnAbrirModal = document.getElementById('btnAbrirModal');
    const btnFecharModal = document.getElementById('btnFecharModal');
    const btnCancelarModal = document.getElementById('btnCancelarModal');
    const btnEnviar = document.getElementById('btnEnviarReserva');
    const btnAcessoInterno = document.getElementById('btnAcessoInterno');

    const inputDataInicio = document.getElementById('inputDataInicio');
    const inputDataFim = document.getElementById('inputDataFim');
    const selectPeriodo = document.getElementById('selectPeriodo');

    const hojeISO = new Date().toISOString().slice(0,10);
    inputDataInicio.min = hojeISO;
    inputDataFim.min = hojeISO;

    const periodosPadrao = {
      INTEGRAL: { label: 'Integral (08h às 18h)', inicio: '08:00', fim: '18:00' },
      MANHA:    { label: 'Manhã (08h às 12h)',   inicio: '08:00', fim: '12:00' },
      TARDE:    { label: 'Tarde (13h às 17h)',   inicio: '13:00', fim: '17:00' },
      NOITE:    { label: 'Noite (18h às 21h)',   inicio: '18:00', fim: '21:00' }
    };

    let calendar;

    function abrirModal(dataISO) {
      modalBackdrop.style.display = 'flex';
      const dataEscolhida = dataISO || hojeISO;
      inputDataInicio.value = dataEscolhida;
      inputDataFim.value = dataEscolhida;
      montarPeriodosLivres(dataEscolhida);
    }

    function fecharModal() {
      modalBackdrop.style.display = 'none';
    }

    async function montarPeriodosLivres(dataISO) {
      selectPeriodo.innerHTML = '';
      selectPeriodo.disabled = true;

      try {
        const resp = await fetch(`${API_BASE}/periodos-livres?data=${dataISO}`);
        const periodos = await resp.json();

        if (!periodos || periodos.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'Nenhum horário disponível neste dia';
          selectPeriodo.appendChild(opt);
          selectPeriodo.disabled = true;
          return;
        }

        periodos.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.label;
          selectPeriodo.appendChild(opt);
        });

        selectPeriodo.disabled = false;
      } catch (err) {
        console.error('Erro ao buscar períodos livres', err);
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Erro ao carregar períodos.';
        selectPeriodo.appendChild(opt);
      }
    }

    function normalizarDataISO(valor) {
      if (!valor) return null;
      if (typeof valor === 'string') {
        return valor.slice(0, 10);
      }
      const d = new Date(valor);
      return d.toISOString().slice(0, 10);
    }

    // Eventos de UI
    btnAbrirModal.addEventListener('click', () => abrirModal());
    btnFecharModal.addEventListener('click', fecharModal);
    btnCancelarModal.addEventListener('click', fecharModal);
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) fecharModal();
    });

    if (btnAcessoInterno) {
      btnAcessoInterno.addEventListener('click', () => {
        window.location.href = '/login.html';
      });
    }

    inputDataInicio.addEventListener('change', (e) => {
      const ini = e.target.value;
      if (!ini) return;
      if (inputDataFim.value && inputDataFim.value < ini) {
        inputDataFim.value = ini;
      }
      montarPeriodosLivres(ini);
    });

    inputDataFim.addEventListener('change', (e) => {
      const fim = e.target.value;
      if (!fim) return;
      const ini = inputDataInicio.value || fim;
      if (fim < ini) {
        alert('A data final não pode ser anterior à data inicial.');
        inputDataFim.value = ini;
      }
    });

    // Calendário
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'pt-br',
      height: 'auto',
      buttonText: { today: 'Hoje' },
      dateClick: function(info) {
        const hoje = new Date();
        hoje.setHours(0,0,0,0);
        const dataClicada = new Date(info.dateStr + 'T00:00:00');

        if (dataClicada < hoje) {
          alert('Não é permitido solicitar reserva para datas já passadas.');
          return;
        }

        abrirModal(info.dateStr);
      },
      events: []
    });
    calendar.render();

    async function carregarReservasNoCalendario() {
  try {
    // usa a rota pública, sem necessidade de login
    const resp = await fetch(`${API_BASE}/reservas-public`);
    const reservas = await resp.json();

    if (!Array.isArray(reservas)) {
      console.warn('Resposta de /reservas-public não é um array.');
      return;
    }


        if (!Array.isArray(reservas)) {
          console.warn('Resposta de /reservas não é um array.');
          return;
        }

        const events = reservas
          .filter(r => {
            const st = (r.status || '').toUpperCase();
            return st !== 'NEGADA' && st !== 'CANCELADA';
          })
          .map(r => {
            const p = periodosPadrao[r.periodo];
            if (!p) return null;

            const inicioISO = normalizarDataISO(r.data_evento);
            const fimISO = normalizarDataISO(r.data_fim || r.data_evento);
            if (!inicioISO || !fimISO) return null;

            const statusUpper = (r.status || '').toUpperCase();
            const isAprovada = statusUpper === 'APROVADA';
            const statusLabel = isAprovada ? 'Confirmado' : 'Solicitado';
            const color = isAprovada ? '#c71c22' : '#f6c344';

            return {
              title: `${statusLabel} – ${r.instituicao}`,
              start: `${inicioISO}T${p.inicio}`,
              end:   `${fimISO}T${p.fim}`,
              color,
              textColor: '#000'
            };
          })
          .filter(Boolean);

        calendar.removeAllEvents();
        calendar.addEventSource(events);
      } catch (err) {
        console.error('Erro ao carregar reservas', err);
      }
    }

    carregarReservasNoCalendario();

    // Enviar solicitação
    btnEnviar.addEventListener('click', async function() {
      const form = document.getElementById('formReserva');
      if (!form.reportValidity()) return;

      const ini = inputDataInicio.value;
      const fim = inputDataFim.value;

      if (!ini || !fim) {
        alert('Informe a data inicial e a data final.');
        return;
      }
      if (fim < ini) {
        alert('A data final não pode ser anterior à data inicial.');
        return;
      }

      const formData = new FormData(form);

      try {
        const resp = await fetch(`${API_BASE}/reservas`, {
          method: 'POST',
          body: formData
        });

        const resposta = await resp.json();

        if (resp.status === 201) {
          alert('Solicitação registrada! Seu pedido será analisado pelo CBMES.');

          const dataInicio = formData.get('data_evento');
          const dataFim = formData.get('data_fim');

          form.reset();

          if (dataInicio) inputDataInicio.value = dataInicio;
          if (dataFim) inputDataFim.value = dataFim;
          if (dataInicio) montarPeriodosLivres(dataInicio);

          fecharModal();
          carregarReservasNoCalendario();
        } else {
          alert(resposta.error || 'Erro ao salvar a solicitação.');
        }
      } catch (err) {
        console.error(err);
        alert('Erro de comunicação com o servidor. Tente novamente mais tarde.');
      }
    });
  });
</script>
</body>
</html>
